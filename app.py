# -*- coding: utf-8 -*-
"""Pose estimation deployment.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1kf-7cR3bYbRIo54-I9uOl0N2U_w8-xci
"""

# ===============================
# STREAMLIT DEPLOYMENT APP
# ===============================

import streamlit as st
import torch
import torch.nn as nn
import torchvision.transforms as transforms
import numpy as np
import matplotlib.pyplot as plt
from PIL import Image

# -------------------------------
# Model Definition
# -------------------------------
class PoseCNN(nn.Module):
    def __init__(self):
        super().__init__()
        self.features = nn.Sequential(
            nn.Conv2d(3, 32, 5, stride=2), nn.ReLU(),
            nn.Conv2d(32, 64, 5, stride=2), nn.ReLU(),
            nn.Conv2d(64, 128, 5, stride=2), nn.ReLU(),
            nn.AdaptiveAvgPool2d((1, 1))
        )
        self.regressor = nn.Sequential(
            nn.Linear(128, 64), nn.ReLU(),
            nn.Linear(64, 6)
        )

    def forward(self, x):
        x = self.features(x)
        x = x.view(x.size(0), -1)
        return self.regressor(x)

# -------------------------------
# Page Config
# -------------------------------
st.set_page_config(page_title="Satellite Pose Estimation", layout="centered")
st.title("üõ∞Ô∏è Markerless 6-DoF Satellite Pose Estimation")

# -------------------------------
# Load Model (LOCAL FILE)
# -------------------------------
@st.cache_resource
def load_model():
    model = PoseCNN()
    model.load_state_dict(torch.load("pose_model.pth", map_location="cpu"))
    model.eval()
    return model

model = load_model()

# -------------------------------
# Preprocessing
# -------------------------------
transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor()
])

# -------------------------------
# Upload Image
# -------------------------------
uploaded = st.file_uploader("Upload spacecraft image", type=["jpg", "png", "jpeg"])

if uploaded:
    image = Image.open(uploaded).convert("RGB")
    st.image(image, caption="Input Image", use_column_width=True)

    x = transform(image).unsqueeze(0)

    with torch.no_grad():
        pose = model(x).squeeze().numpy()

    labels = ["x", "y", "z", "roll", "pitch", "yaw"]

    st.subheader("Predicted Pose Values")
    for l, v in zip(labels, pose):
        st.write(f"**{l}**: {v:.4f}")

    fig, ax = plt.subplots()
    ax.bar(labels, pose)
    ax.set_title("6-DoF Pose Components")
    st.pyplot(fig)

else:
    st.info("Upload an image to run pose estimation.")
